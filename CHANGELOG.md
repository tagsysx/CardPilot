# 📝 CardPilot 版本历史

## 🚀 版本 1.4 (最新版本)
**发布日期**: 2025年8月11日  
**状态**: 🔄 开发中

### ✨ 新功能
- **位置权限管理增强**
  - 新增位置权限状态检查和手动权限请求功能
  - 在设置页面添加位置权限管理区域，显示当前权限状态
  - 提供详细的位置权限故障排除指南
  - 支持用户手动触发位置权限请求，解决权限被拒绝的问题
  - 改进位置权限错误处理，提供更清晰的用户指导信息

- **数据持久化到File目录**
  - 将SwiftData数据自动备份到File目录，确保应用删除或更新后数据不丢失
  - 支持手动备份和自动备份，创建带时间戳的备份文件
  - 提供数据恢复功能，应用启动时自动检测并恢复备份数据
  - 备份文件存储在Documents目录，可通过Files应用访问和分享
  - 智能备份管理，自动清理旧备份文件，保持存储空间整洁

### 🐛 Bug修复
- **修复位置权限被拒绝时的用户体验问题**
  - 问题：当用户拒绝位置权限后，应用无法收集位置数据，但缺乏明确的用户指导
  - 原因：位置权限被拒绝后，应用没有提供清晰的故障排除路径
  - 解决方案：
    - 在设置页面添加位置权限状态显示
    - 提供手动权限请求按钮，允许用户重新触发权限对话框
    - 创建详细的位置权限故障排除指南
    - 改进错误消息，提供具体的解决步骤
  - 影响：提升用户体验，减少因权限问题导致的功能不可用

- **修复App Intent网络连接崩溃问题**
  - 问题：当App Intent激活后，应用通过GPS获取地址信息时，如果没有网络连接就会报错并可能崩溃
  - 原因：地址解析函数`parseAddressFromCoordinates`和IP地址获取函数`getCurrentIPAddress`没有检查网络连接状态
  - 解决方案：
    - 添加网络连接状态检查函数`isNetworkAvailable()`
    - 改进地址解析函数，网络不可用时返回nil而不是抛出错误
    - 改进IP地址获取函数，添加本地IP地址备选方案
    - 实现优雅降级，确保应用在网络不可用时仍能正常运行
  - 影响：大幅提升应用稳定性，避免网络不可用时的崩溃问题

- **修复传感器数据收集中的错误处理**
  - 问题：多个传感器数据收集函数使用`try? await`，错误被静默忽略
  - 原因：错误处理不当，可能导致数据收集失败时应用行为不可预测
  - 解决方案：
    - 将`try? await`改为`try await`，确保错误被正确传播和处理
    - 改进JSON编码错误处理，添加详细的错误日志
    - 优化WiFi SSID获取函数的错误处理
  - 影响：提升错误处理的一致性，改善调试体验

### 🔧 技术改进
- **位置权限管理优化**
  - 新增`manuallyRequestLocationPermission()`方法，支持用户手动触发权限请求
  - 新增`checkLocationPermissionStatus()`方法，提供详细的权限状态信息
  - 改进位置权限错误处理，提供更清晰的用户指导信息
  - 在设置页面集成位置权限管理功能

- **网络连接管理**
  - 实现基于`NWPathMonitor`的网络状态监控
  - 添加2秒超时机制，避免网络检查无限等待
  - 支持本地IP地址获取作为网络不可用时的备选方案
  - 优化网络错误分类和处理逻辑

- **错误处理优化**
  - 统一错误处理模式，避免静默失败
  - 改进continuation使用，防止重复调用
  - 增强日志记录，提供更好的调试信息
  - 实现优雅降级策略，确保应用在各种异常情况下都能稳定运行

- **代码质量提升**
  - 修复潜在的continuation泄漏问题
  - 改进异步操作的超时处理
  - 优化内存管理和资源释放
  - 增强类型安全性和编译稳定性

### 📱 用户体验
- 新增位置权限管理界面，用户可以轻松检查和请求位置权限
- 提供详细的位置权限故障排除指南，解决常见的权限问题
- 应用在网络不可用时不再崩溃，提供更稳定的使用体验
- 改进的错误处理提供更好的调试信息
- 优雅降级确保核心功能在各种网络环境下都能正常工作

---

## 🚀 版本 1.4
**发布日期**: 2025年8月11日  
**状态**: ✅ 已发布

### ✨ 新功能
- **Session管理功能**
  - 支持删除单个NFC session记录
  - 提供确认对话框防止误删
  - 优化数据管理体验

- **标签系统增强**
  - 新增小标签功能，支持快速分类
  - 新增大标签功能，支持详细描述
  - 标签颜色区分，提升视觉识别度
  - 支持标签编辑和删除

- **地图视图优化**
  - 重构LocationMapView支持多session显示
  - 修复重复声明和类型推断问题
  - 支持批量位置数据展示

- **WiFi SSID功能集成**
  - 新增WiFi网络名称获取功能
  - 集成到NFC Session数据模型中
  - 在Network部分显示WiFi SSID信息
  - 支持模拟器和真机环境的WiFi数据获取

- **WiFi SSID Shortcuts集成**
  - 突破iOS隐私限制：通过Shortcuts应用获取真实WiFi SSID
  - URL Scheme扩展：支持通过`cardpilot://collect?ssid=`传递WiFi网络名称
  - 智能回退机制：优先使用外部SSID，失败时回退到网络连接状态
  - 时效性管理：外部SSID有效期5分钟，确保数据时效性
  - 无缝集成：与现有NFC自动化完美配合

- **数据导出格式优化**
  - 重构JSON导出格式，采用结构化对象设计
  - Location数据：将经纬度字符串拆分为独立的latitude和longitude数值字段
  - Screen数据：将screenState、screenBrightness、screenStateHistory合并为统一的screen对象
  - NFC数据：将NFC信息字符串拆分为type、source、duration、tagData等结构化字段
  - Network数据：将ipAddress和wifiSSID合并为统一的network对象，提供完整的网络连接信息
  - 用户标签集成：支持用户自定义的locationTag在所有导出格式中完整保存
  - 提升数据可读性和程序解析效率

- **URL参数名称优化**
  - 将NFC UID参数从`shortcutInput`更改为`nfc`，提升语义清晰度
  - 新的URL格式：`cardpilot://collect?sourceApp=Shortcuts&autoExit=true&silent=true&ssid=[ssid]&nfc=[uid]`
  - 保持向后兼容性，所有相关代码和文档同步更新

### 🐛 Bug修复
- **修复NFC session重复记录问题**
  - 问题：每次NFC触发会创建两条相同的session记录
  - 原因：ContentView中存在两个重复的URL scheme处理器
  - 解决方案：移除SessionsView中的重复URL处理，只保留ContentView级别的处理
  - 影响：避免数据重复，提高数据质量

- **修复LocationMapView编译错误**
  - 问题：LocationMapView结构体重复声明
  - 原因：AnalyticsView.swift中存在重复的LocationMapView定义
  - 解决方案：删除重复声明，统一使用LocationMapView.swift
  - 影响：解决编译错误，提升代码质量

### 🔧 技术改进
- 优化URL scheme处理流程
- 简化代码结构，减少重复逻辑
- 提升应用性能和稳定性
- 重构地图视图架构，支持多数据源
- 改进类型安全性和编译稳定性
- 集成SystemConfiguration框架支持WiFi信息获取
- 优化网络数据收集和存储流程
- 重构数据导出架构，采用结构化JSON设计模式
- 增强数据模型扩展性，支持嵌套对象结构
- 优化导出性能，提升大数据量处理能力
- 实现WiFi SSID管理器：全局状态管理，支持外部数据源集成
- 扩展URL Scheme处理：新增参数解析能力，提升自动化集成度

### 📱 用户体验
- 修复了数据重复问题，提供更准确的使用统计
- 提升了应用响应速度
- 减少了内存占用

---

## 📋 版本 1.0 (首发版本)
**发布日期**: 2024年09月08日

### ✨ 新功能
- **基础NFC数据收集**
  - GPS位置追踪（经纬度坐标）
  - 详细地址信息（街道、城市、州、国家等）
  - 网络信息（IP地址）
  - 运动传感器数据（IMU数据）
  - 环境传感器数据（磁力计、气压计、环境光等）
  - 音频数据收集

- **iOS快捷指令集成**
  - 支持NFC标签触发
  - URL scheme支持
  - 自动数据收集

- **数据管理**
  - 本地数据存储（SwiftData）
  - 数据查看和管理界面
  - 搜索和筛选功能

### 🏗️ 技术架构
- SwiftUI + SwiftData
- CoreLocation集成
- CoreMotion集成
- AVFoundation集成
- 异步编程（async/await）

### 📋 系统要求
- iOS 17.0+
- 支持NFC的设备
- 位置权限
- 运动与健身权限
- 麦克风权限

---

## 🔮 计划版本

### 📋 版本 1.2 ✅ 已完成
**发布日期**: 2025年1月

#### ✨ 新功能
- **智能NFC类型识别增强**
  - 基于历史使用模式的智能推荐
  - 自动学习用户的使用习惯
  - 更准确的NFC用途分类

- **数据导出功能增强**
  - 支持CSV、JSON格式导出
  - 批量导出历史数据
  - 云端备份选项

- **高级分析功能**
  - 使用频率趋势分析
  - 地理位置热力图
  - 使用时间模式分析

#### 🎨 用户体验改进
- 更直观的数据可视化
- 个性化设置选项
- 快捷操作手势支持

### 📋 版本 1.4 ✅ 当前版本
**发布日期**: 2025年1月

#### ✨ 新功能
- **多设备同步**
  - iCloud数据同步
  - 跨设备使用记录
  - 设备间数据合并

- **智能提醒系统**
  - 基于位置的NFC使用提醒
  - 使用频率异常提醒
  - 个性化通知设置

- **高级隐私控制**
  - 数据匿名化选项
  - 选择性数据收集
  - 隐私级别设置

### 📋 版本 2.0 (长期规划)
**预计发布日期**: 2025年Q2

#### 🚀 重大功能升级
- **AI驱动的数据分析**
  - 机器学习算法优化
  - 智能异常检测
  - 预测性分析

- **扩展的NFC支持**
  - 更多NFC标签类型
  - 自定义NFC操作
  - NFC标签管理

- **生态系统集成**
  - 第三方应用集成
  - API接口开放
  - 开发者工具包

---

## 📊 版本命名规范

### 版本号格式
- **主版本号.次版本号.修订版本号**
- 例如：1.1.0, 1.2.1, 2.0.0

### 版本类型说明
- **主版本号**：重大功能更新或架构变更
- **次版本号**：新功能添加和重要改进
- **修订版本号**：Bug修复和小幅改进

---

## 🔄 更新流程

### 开发阶段
1. 功能开发和测试
2. 内部代码审查
3. 用户测试反馈收集

### 发布阶段
1. 版本号更新
2. 更新日志编写
3. 应用商店发布
4. 用户通知

### 维护阶段
1. 用户反馈收集
2. Bug修复和优化
3. 性能监控和改进

---

## 📞 反馈和支持

### 问题报告
- 使用应用内反馈功能
- 通过GitHub Issues报告
- 邮件联系开发团队

### 功能建议
- 欢迎提出新功能建议
- 参与用户调查
- 加入社区讨论

### 兼容性
- 版本1.1.0与1.0.0数据完全兼容
- 无需数据迁移
- 保持所有现有功能

---

*最后更新: 2025年8月11日*